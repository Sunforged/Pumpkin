<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Pumpkin - Open Commenting System</title>

    <style type="text/css">
        * {
            font-family: Optima, Segoe, "Segoe UI", Candara, Calibri, Arial, sans-serif;
            font-size: 14px;
            color: #000; 
        }

        h1 {
            font-size: 24px;
        }

        body {
            text-align: center;
        }

        ol#topics {
            padding: 0px;
            cursor: pointer;i
        }

        li {
            padding: 10px;
        }

        #wrapper {
            width: 700px;
            margin: 0 auto;
            text-align: left;
        }

        .hidden {
            visibility: hidden;
        }
    </style>

    <script src="http://code.jquery.com/jquery-1.9.0.min.js"></script>
    <script type="text/javascript"> 

        $(document).ready(function() {

            function refreshTopics() {
                $.get('/topic/all', function(data) {
                    $("#topics").html("");
                    var count = 0;
                    for(var prop in data) {
                        var id = data[prop].id,
                            text = data[prop].text,
                            weight = data[prop].weight,
                            replies = data[prop].replies;
                        if (typeof data[prop].link !== "undefined") {
                            link = data[prop].link.split(/\/\//);
                            link = (link.length > 1) ? link[1] : link[0];
                        }

                        topic_el = $("<li class='topic'>" + text
                                + " <span class='link'>(<a href='" + "http://" + link + "'>" + link + "</a>)</span><br />"
                                + "<span class='subtext'>" + weight + " points | " 
                                + Object.keys(replies).length + " replies</span></li>");

                        function compileReplies(some_replies) {
                            var reply_list = $("<ol></ol>");
                            for (var k in some_replies) {
                                var reply = $("<li>" + some_replies[k].text + "</li>");

                                console.log(Object.keys(some_replies[k].replies).length);
                                if (Object.keys(some_replies[k].replies).length > 0) {
                                    reply.append(compileReplies(some_replies[k].replies));
                                }
                                reply_list.append(reply);
                            }

                            return reply_list;
                        }
                        
                        var replies_el = compileReplies(replies);
                        replies_el.addClass('replies');

                        topic_el.append(replies_el);
                        replies_el.hide();

                        topic_el.click(function() {
                            $(this).find(".replies").slideToggle();
                        });

                        $("#topics").append(topic_el);
                    }
                });
            }
            
            $("#addTopicForm").submit(function(event) {
                event.preventDefault();
                var callbackurl = '/topic/add?' + $('#addTopicForm').serialize();
                $.post(callbackurl).done(refreshTopics);

                //clear form fields
                $(this).find("input[type=text], text").val("");
                $(this).find("input[type=text], link").val("");
            });
			
            refreshTopics();
        });

    </script> 

  </head>

  <body>
    <div id="wrapper">
      <h1>Pumpkin</h1>
        <ol id="topics">
        </ol>
        <form id="addTopicForm" action="">
            <input type="text" name="text" placeholder="Text">
            <input type="text" name="link" placeholder="Link">
            <input type="submit" value="Submit">
        </form>
    </div>
  </body>
</html>
